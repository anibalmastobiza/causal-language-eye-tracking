<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abstract Evaluation - Pair 2</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; line-height: 1.6; background-color: #f8f9fa; color: #333; }
        .survey-container { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header h1 { color: #2c3e50; font-size: 28px; }
        .progress-indicator { text-align: center; margin-bottom: 30px; padding: 15px; background-color: #e7f3ff; border-radius: 8px; }
        .section-title { font-size: 20px; font-weight: bold; color: #2c3e50; margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 1px solid #dee2e6; }
        .abstract-display { display: flex; gap: 25px; margin: 25px 0; }
        .abstract-box { flex: 1; padding: 20px; border: 2px solid #dee2e6; border-radius: 8px; }
        .abstract-title { font-weight: bold; margin-bottom: 15px; color: #007bff; font-size: 18px; text-align: center; }
        .abstract-text { line-height: 1.8; font-size: 16px; color: #495057; text-align: justify; }
        .continue-btn { background: #007bff; color: white; padding: 15px 40px; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; display: block; margin: 40px auto 0; }
        .reading-timer { position: fixed; top: 20px; left: 20px; background-color: rgba(40, 167, 69, 0.9); color: white; padding: 10px 15px; border-radius: 8px; z-index: 1000; }
        #webgazerVideoFeed { position: fixed; top: 20px; right: 20px; width: 150px; height: 112px; border: 2px solid #28a745; z-index: 1000; }
    </style>
</head>
<body>
    <div class="reading-timer" id="readingTimer">Reading Time: 0:00</div>
    <div class="survey-container">
        <div class="header"><h1>Abstract Evaluation - Pair 2</h1></div>
        <div class="progress-indicator"><strong>Step 3 of 4:</strong> Reading Task | Eye tracking is active</div>
        <div class="section-title">ðŸ“„ Reading Task</div>
        <p>Please read both abstracts carefully. When you are finished, click the "Continue" button below.</p>
        <div class="abstract-display">
            <div class="abstract-box" id="abstractA"><div class="abstract-title">Abstract A</div><div class="abstract-text">This study underlies that ethical reasoning facilitates moral judgment in artificial intelligence systems. The analysis constrains algorithmic bias through dialectical relationships that function as catalysts for technological change. Research explains variance in discriminatory outcomes through mediating variables that enable fair decision-making processes.</div></div>
            <div class="abstract-box" id="abstractB"><div class="abstract-title">Abstract B</div><div class="abstract-text">This study relates to ethical reasoning that supports moral judgment in artificial intelligence systems. The analysis reduces algorithmic bias through relationships that act as factors for technological change. Research shows variation in discriminatory outcomes through variables that support fair decision-making processes.</div></div>
        </div>
        <button id="continueBtn" class="continue-btn" onclick="goToNextStep()">Continue to Final Questions</button>
    </div>

    <script>
        let startTime;
        let gazeData = [];
        let readingTimeInterval;

        async function startEyeTracking() {
            if (sessionStorage.getItem('eyeTrackingCalibrated') !== 'true') {
                alert('Eye tracking not calibrated. Redirecting to calibration page.');
                window.location.href = 'calibration.html';
                return;
            }

            try {
                // Force a restart of webgazer on this page
                await webgazer.setRegression('ridge').setTracker('clmtrackr').begin();
                webgazer.showVideoPreview(true).showPredictionPoints(false);
                
                // Set the listener AFTER it has started
                webgazer.setGazeListener((data, elapsedTime) => {
                    if (data == null) return;
                    gazeData.push({ x: data.x, y: data.y, t: elapsedTime, page: 'abstract2' });
                });

                console.log('WebGazer RESTARTED for Abstract 2');
                
                startTime = Date.now();
                readingTimeInterval = setInterval(updateReadingTimer, 1000);
            } catch (err) {
                console.error("Failed to restart WebGazer:", err);
                alert("There was an error activating the eye tracker. Please ensure camera permissions are still granted.");
            }
        }

        function updateReadingTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('readingTimer').textContent = `Reading Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function goToNextStep() {
            const data = {
                readingTime: Date.now() - startTime,
                gazeDataCount: gazeData.length
            };
            sessionStorage.setItem('abstract2Data', JSON.stringify(data));
            sessionStorage.setItem('abstract2GazeData', JSON.stringify(gazeData));
            // End the current session before navigating
            if (webgazer.isReady()) {
                webgazer.end();
            }
            window.location.href = 'results.html';
        }

        window.addEventListener('load', startEyeTracking);
    </script>
</body>
</html>
